# ğŸ BRIK Python CI/CD Pipeline V1.0.0 Enhanced
# Enterprise-grade workflow con L0-L3 certification gates
# Optimizado para Python ecosystem, multiple versions y security

name: "ğŸ BRIK Python Enhanced"

on:
  push:
    branches: [ main, develop, v1.0.0-stabilization ]
    paths:
      - '**/*.py'
      - '**/requirements.txt'
      - '**/pyproject.toml'
      - '**/setup.py'
      - '**/setup.cfg'
      - '**/pytest.ini'
      - '.github/workflows/brik-python-enhanced.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - '**/requirements.txt'
      - '**/pyproject.toml'
      - '**/setup.py'
      - '**/setup.cfg'
      - '**/pytest.ini'
      - '.github/workflows/brik-python-enhanced.yml'

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  # NOTE: PIP_NO_CACHE_DIR removed to enable caching
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PYTEST_ADDOPTS: "--strict-markers --disable-warnings --tb=short"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ¯ GATE L0: Foundation Testing + Setup Validation
  level-0-foundation:
    name: "ğŸ¯ L0: Foundation (Basic Tests + Lint)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        python: ['3.9', '3.10', '3.11', '3.12']
        project: ['demo-py']
    
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      python-version: ${{ matrix.python }}
      
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "ğŸ Setup Python ${{ matrix.python }}"
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python }}
        cache: 'pip'
        cache-dependency-path: '${{ matrix.project }}/requirements.txt'
        
    - name: "ğŸ“¦ Generate cache key"
      id: cache-key
      run: |
        echo "key=python-${{ matrix.python }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}" >> $GITHUB_OUTPUT
        
    - name: "ğŸ”§ Install system dependencies"
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: "ğŸ“¦ Install Python dependencies"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ“¦ Installing dependencies for ${{ matrix.project }}..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-xdist ruff mypy black isort bandit
        
    - name: "ğŸ” Verify installation"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ” Verifying Python setup..."
        python --version
        pip --version
        pip list
        
    - name: "ğŸ¨ Code formatting check (Black)"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ¨ Running Black formatting check..."
        black --check --diff . || echo "Formatting issues found (non-blocking for L0)"
        
    - name: "ğŸ“ Import sorting check (isort)"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ“ Running isort check..."
        isort --check-only --diff . || echo "Import sorting issues found (non-blocking for L0)"
        
    - name: "ğŸ” Basic linting (Ruff)"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ” Running Ruff linting..."
        ruff check . --output-format=github || echo "Linting issues found (non-blocking for L0)"
        
    - name: "ğŸ§ª Basic tests"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ§ª Running basic test suite..."
        pytest -v --tb=short tests/ || echo "Some tests failed (non-blocking for L0)"
        
    - name: "âœ… L0 Gate Validation"
      run: |
        echo "âœ… L0 FOUNDATION GATE PASSED for Python ${{ matrix.python }}"
        echo "- Dependencies: âœ… INSTALLED"
        echo "- Formatting: âœ… CHECKED"
        echo "- Linting: âœ… COMPLETED"
        echo "- Basic tests: âœ… EXECUTED"

  # ğŸ—ï¸ GATE L1: Core Functionality + Coverage
  level-1-core:
    name: "ğŸ—ï¸ L1: Core (Coverage + Quality)"
    runs-on: ubuntu-latest
    needs: level-0-foundation
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        python: ['3.11']  # Primary version for core testing
        project: ['demo-py']
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python ${{ matrix.python }}"
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python }}
        cache: 'pip'
        cache-dependency-path: '${{ matrix.project }}/requirements.txt'
        
    - name: "ğŸ”§ Install system dependencies"
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: "ğŸ“¦ Install dependencies"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-xdist ruff mypy black isort bandit
        
    - name: "ğŸ§ª Run comprehensive tests with coverage"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ§ª Running comprehensive test suite with coverage..."
        pytest --cov=src --cov-branch --cov-report=xml --cov-report=term --cov-report=html -v
        
    - name: "ğŸ“Š Extract coverage metrics"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ“Š Extracting coverage metrics..."
        if [ -f "coverage.xml" ]; then
          COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    line_rate = root.get('line-rate')
    if line_rate:
        print(int(float(line_rate) * 100))
    else:
        print(0)
except:
    print(0)
          ")
          echo "Coverage extracted: ${COVERAGE}%"
          echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
        else
          echo "Coverage file not found"
          echo "COVERAGE=0" >> $GITHUB_ENV
        fi
        
    - name: "âœ… Verify L1 coverage (â‰¥80%)"
      working-directory: ${{ matrix.project }}
      run: |
        echo "Coverage for ${{ matrix.project }}: ${COVERAGE}%"
        if [ "$COVERAGE" -ge 80 ]; then
          echo "âœ… L1 PASSED: Coverage ${COVERAGE}% â‰¥ 80%"
        else
          echo "âŒ L1 FAILED: Coverage ${COVERAGE}% < 80%"
          exit 1
        fi
        
    - name: "ğŸ” Enhanced linting"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ” Running enhanced linting..."
        ruff check . --output-format=github
        
    - name: "ğŸ” Type checking (MyPy)"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ” Running MyPy type checking..."
        mypy src/ --strict || echo "Type checking completed with issues"
        
    - name: "ğŸ“¤ Upload coverage to Codecov"
      uses: codecov/codecov-action@v4
      with:
        directory: ${{ matrix.project }}
        flags: python-l1
        name: python-l1-coverage
        
    - name: "ğŸ“‹ Upload coverage artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: python-coverage-${{ matrix.python }}
        path: |
          ${{ matrix.project }}/coverage.xml
          ${{ matrix.project }}/htmlcov/
        retention-days: 7

  # âš¡ GATE L2: Performance + Multi-OS Validation
  level-2-performance:
    name: "âš¡ L2: Performance (Multi-OS + Advanced)"
    runs-on: ${{ matrix.os }}
    needs: level-1-core
    timeout-minutes: 25
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ['3.11']
        project: ['demo-py']
        
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python ${{ matrix.python }}"
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python }}
        cache: 'pip'
        cache-dependency-path: '${{ matrix.project }}/requirements.txt'
        
    - name: "ğŸ”§ Install system dependencies (Ubuntu)"
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: "ğŸ“¦ Install dependencies"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ“¦ Installing dependencies on ${{ matrix.os }}..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-xdist pytest-benchmark
        
    - name: "ğŸ§ª Run platform-specific tests"
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ§ª Running tests on ${{ matrix.os }}..."
        pytest -v --tb=short tests/
        
    - name: "âš¡ Performance benchmarking"
      if: matrix.os == 'ubuntu-latest'
      working-directory: ${{ matrix.project }}
      run: |
        echo "âš¡ Running performance benchmarks..."
        pytest --benchmark-only --benchmark-json=benchmark.json || echo "Benchmarks completed"
        
    - name: "ğŸ” Advanced validation"
      if: matrix.os == 'ubuntu-latest'
      working-directory: ${{ matrix.project }}
      run: |
        echo "ğŸ” Running advanced validation..."
        pip install bandit safety
        bandit -r src/ -f json -o bandit-report.json || echo "Security scan completed"
        safety check --json --output safety-report.json || echo "Safety check completed"
        
    - name: "âœ… L2 Gate Validation"
      run: |
        echo "âœ… L2 PERFORMANCE GATE PASSED on ${{ matrix.os }}"
        echo "- Multi-platform tests: âœ… PASSED"
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          echo "- Performance benchmarks: âœ… COMPLETED"
          echo "- Security validation: âœ… COMPLETED"
        fi
        
    - name: "ğŸ“‹ Upload performance artifacts"
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: python-performance-reports
        path: |
          ${{ matrix.project }}/benchmark.json
          ${{ matrix.project }}/bandit-report.json
          ${{ matrix.project }}/safety-report.json
        retention-days: 7

  # ğŸ† GATE L3: Production Readiness + Certification
  level-3-certification:
    name: "ğŸ† L3: Certification (Production Ready)"
    runs-on: ubuntu-latest
    needs: level-2-performance
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/v1.0.0-stabilization'
    timeout-minutes: 30
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'demo-py/requirements.txt'
        
    - name: "ğŸ”§ Install system dependencies"
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: "ğŸ“¦ Install L3 dependencies"
      working-directory: demo-py
      run: |
        echo "ğŸ“¦ Installing L3 certification dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-xdist pytest-benchmark
        pip install ruff mypy black isort bandit safety
        
    - name: "ğŸ§ª Run L3 comprehensive test suite"
      working-directory: demo-py
      run: |
        echo "ğŸ§ª Running L3 comprehensive test suite..."
        pytest --cov=src --cov-branch --cov-report=xml --cov-report=html --cov-report=term -v --maxfail=0
        
    - name: "ğŸ“Š Extract L3 coverage"
      working-directory: demo-py
      run: |
        echo "ğŸ“Š Extracting L3 coverage metrics..."
        if [ -f "coverage.xml" ]; then
          COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    line_rate = root.get('line-rate')
    if line_rate:
        print(int(float(line_rate) * 100))
    else:
        print(0)
except Exception as e:
    print(0)
          ")
          echo "L3 Coverage: ${COVERAGE}%"
          echo "L3_COVERAGE=${COVERAGE}" >> $GITHUB_ENV
        else
          echo "âŒ Coverage file not found"
          echo "L3_COVERAGE=0" >> $GITHUB_ENV
        fi
        
    - name: "âœ… Verify L3 coverage (â‰¥95%)"
      working-directory: demo-py
      run: |
        if [ "$L3_COVERAGE" -ge 95 ]; then
          echo "âœ… L3 PASSED: Coverage ${L3_COVERAGE}% â‰¥ 95%"
        else
          echo "âŒ L3 FAILED: Coverage ${L3_COVERAGE}% < 95%"
          exit 1
        fi
        
    - name: "ğŸ¨ Enhanced code quality validation"
      working-directory: demo-py
      run: |
        echo "ğŸ¨ Running enhanced code quality validation..."
        black --check --diff .
        isort --check-only --diff .
        ruff check . --output-format=github
        echo "âœ… Code quality validation passed"
        
    - name: "ğŸ” Strict type checking"
      working-directory: demo-py
      run: |
        echo "ğŸ” Running strict type checking..."
        mypy src/ --strict
        echo "âœ… Strict type checking passed"
        
    - name: "ğŸ”’ Security audit (enhanced)"
      working-directory: demo-py
      run: |
        echo "ğŸ”’ Running enhanced security audit..."
        bandit -r src/ -f json -o bandit-report.json
        safety check --json --output safety-report.json
        echo "âœ… Enhanced security audit completed"
        
    - name: "ğŸ” BRIK Certification"
      working-directory: demo-py
      run: |
        echo "ğŸ” Running BRIK certification..."
        chmod +x ./scripts/brik-certify.sh
        chmod +x ./scripts/test-coverage.sh
        STRICT_DOCS=1 ./scripts/brik-certify.sh
        
    - name: "ğŸ† L3 Certification Summary"
      working-directory: demo-py
      run: |
        echo "ğŸ† BRIK PYTHON L3 CERTIFICATION COMPLETE"
        echo "ğŸ“Š Coverage: ${L3_COVERAGE}%"
        echo "ğŸ” BRIK Hash: $(cat .brik-cert.sha256 2>/dev/null || echo 'Generated')"
        echo "ğŸ¨ Code Quality: âœ… PASSED"
        echo "ğŸ” Type Safety: âœ… PASSED"
        echo "ğŸ”’ Security Audit: âœ… PASSED"
        echo "ğŸ† L3 Certification: âœ… COMPLETE"
        
    - name: "ğŸ“¤ Upload L3 coverage"
      uses: codecov/codecov-action@v4
      with:
        directory: demo-py
        flags: python-l3
        name: python-l3-certification
        fail_ci_if_error: true
        
    - name: "ğŸ“‹ Upload L3 certification artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: python-l3-certification
        path: |
          demo-py/coverage.xml
          demo-py/htmlcov/
          demo-py/bandit-report.json
          demo-py/safety-report.json
          demo-py/.brik-cert.*
        retention-days: 30
        
    - name: "ğŸ¯ Performance validation"
      working-directory: demo-py
      run: |
        echo "ğŸ¯ Running L3 performance validation..."
        pytest --benchmark-only --benchmark-json=l3-benchmark.json || echo "Performance validation completed"

  # ğŸš€ Deployment Ready Notification
  deployment-ready:
    name: "ğŸš€ Deployment Ready"
    runs-on: ubuntu-latest
    needs: [level-0-foundation, level-1-core, level-2-performance, level-3-certification]
    if: always()
    
    steps:
    - name: "ğŸ“Š Workflow Summary"
      run: |
        echo "## ğŸ BRIK Python Pipeline Summary"
        echo "- L0 Foundation: ${{ needs.level-0-foundation.result }}"
        echo "- L1 Core: ${{ needs.level-1-core.result }}"
        echo "- L2 Performance: ${{ needs.level-2-performance.result }}"
        echo "- L3 Certification: ${{ needs.level-3-certification.result }}"
        
        if [ "${{ needs.level-3-certification.result }}" == "success" ] || [ "${{ needs.level-2-performance.result }}" == "success" ]; then
          echo "ğŸš€ PYTHON COMPONENT: DEPLOYMENT READY"
        else
          echo "âš ï¸ PYTHON COMPONENT: DEPLOYMENT NOT READY"
        fi
        
    - name: "ğŸ”’ Security Summary"
      if: needs.level-2-performance.result == 'success' || needs.level-3-certification.result == 'success'
      run: |
        echo "## ğŸ”’ Security Validation Summary"
        echo "- Bandit security scan: âœ… COMPLETED"
        echo "- Safety dependency check: âœ… COMPLETED"
        echo "- Code quality validation: âœ… PASSED"